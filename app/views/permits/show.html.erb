<%= render 'shared/status_bar' %>

<div class="container" style="border: 2px solid $grey-lighter; padding: 0px; display: flex; min-height: 100vh; margin-top: 75px;">

<!-- Left side of the show, with the Clickable Sections -->
  <div class="section-container">
    <div class="section-item section-header-active" data-id="1"><p><span>Section 1</span><br>Permit Details</p></div>
    <div class="section-item" data-id="2"><p><span>Section 2</span><br>Excavation dimensions</p></div>
    <div class="section-item" data-id="3"><p><span>Section 3</span><br>Services located in the area</p></div>
    <div class="section-item" data-id="4"><p><span>Section 4</span><br>Confirmation</p></div>
    <div class="section-item" data-id="5"><p><span>Section 5</span><br>Mechanical Dig</p></div>
  </div>

  <!-- Middle section with the permit info -->

  <div class="selected-container">
    <div class="selected-section show-section" data-id="1">
      <div class="container-permit-details center-detail">
        <h2 class="center-text"><strong>Project <%= @permit.project_id %></strong></h2>
        <p class="center-text"><%= @permit.permit_number %></p>
        <div class="two-grid center-text">
          <p><strong>Begins:</strong> <span class="begin"><%= @permit.start_date.strftime("%d-%m-%Y") %> <%= @permit.start_date.strftime("%I:%M%P") %></span></p> <p><strong>Expires:</strong> <span class="end"><%= @permit.end_date.strftime("%d-%m-%Y") %> at <%= @permit.end_date.strftime("%I:%M%P") %></span></p>
        </div>
        <!-- To be deleted when js logic is made -->
        <p class="center-text">Expires in xxx days</p>
        <% if @permit.status == "draft" %>
          <p class="center-text status-show"><i><strong>DRAFT</strong></i></p>
        <% elsif @permit.status == "pending approval" %>
          <p class="center-text status-show">Awaiting approval from <strong><%= @approver %></strong></p>
        <% elsif @permit.status == "approved" %>
          <p class="center-text status-show">Approved by: <strong><%= @approver %></strong></p>
        <% elsif @permit.status == "rejected" %>
          <p class="center-text status-show">Permit rejected by: <strong><%= @approver %></strong></p>
        <%# elsif @permit.status == "expired" %>
          <!-- <p><strong>Permit expired</strong></p> -->
        <% end %>

        <div class="details">
          <div>
            <p><strong>Permit title:</strong></p>
            <p><strong>Level:</strong></p>
            <p><strong>Location:</strong></p>
            <p><strong>Method Statement:</strong></p>
            <p><strong>Permit Type:</strong></p>
          </div>
          <div class="detail-info">
            <p><%= @permit.title %></p>
            <p><%= @permit.level %></p>
            <p><%= @permit.location %></p>
            <p><%= @permit.method_statement %></p>
            <p><%= @permit.permit_type %></p>
          </div>
        </div>
      </div>
    </div>


    <div class="selected-section" data-id="2">
      <div class="container">
        <div class="excavation center-detail move">
          <div class="permit-images">
            <%= image_tag("dimension.jpg") %>
            <%= image_tag("dimension2.jpg") %>
          </div>
          <p class="width">xwidth: <strong><%= @permit.xwidth %>mm</strong></p>
          <p class="depth">xdepth: <strong><%= @permit.xdepth %>mm</strong></p>
          <p class="length">xlength: <strong><%= @permit.xlength %>m</strong></p>
        </div>
      </div>
    </div>


    <div class="selected-section" data-id="3">
      <div class="container">
        <div class="excavation center-detail">
          <% @permit.attributes.to_a[(13..24)].each do |ele| %>
            <% if ele[1] == true %>
              <p><%= ele[0].gsub(/_/, " ").capitalize %></p>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>


    <div class="selected-section" data-id="4">
      <div class="container">
        <div class="excavation center-detail">
          <p>Cat Scanner model: <%= @permit.cat_scan_model %></p>
          <p> Serial number: <%= @permit.cat_scanner_serial %></p>
          <p>Genny model: <%= @permit.genny_model %></p>
          <p> Serial number: <%= @permit.genny_serial %></p>
          <p>Operator: <%= @permit.cat_genny_operator %></p>
          <p>Calibration expires: <%= @permit.calibration_expires.strftime("%d-%m-%Y") %></p>
          <p>Modes used:</p>
          <ul>
            <% if @permit.cat_mode_power == true %>
              <li>Power <i class="far fa-check-circle"></i></li>
            <% else %>
              <li>Power <i class="far fa-times-circle"></i></li>
            <% end %>
            <% if @permit.cat_mode_radio == true %>
              <li>Radio <i class="far fa-check-circle"></i></li>
            <% else %>
              <li>Radio <i class="far fa-times-circle"></i></li>
            <% end %>
            <% if @permit.cat_mode_transmitter == true %>
              <li>Transmitter <i class="far fa-check-circle"></i></li>
            <% else %>
              <li>Transmitter <i class="far fa-times-circle"></i></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>


    <div class="selected-section" data-id="5">
      <div class="container">
        <div class="mechanical-dig center-detail">
          <% @permit.attributes.to_a[(25..33)].each do |ele| %>
            <% if ele[1] == true %>
              <p class="tag"><%= ele[0].gsub(/_/, " ").capitalize %></p>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

<!-- Right side with button and user card -->

  <div class="action-btn-container">
    <% if (@permit.status == "pending approval" && @permit.approver == current_user) %>
      <div class="container-btn-approval">
        <%= link_to 'Approve permit', permit_approve_path(@permit), class: "approve-btn"%>
        <%= link_to 'Reject permit', permit_reject_path(@permit), class: "approve-btn reject-btn" %>
      </div>
    <% elsif (@permit.status == "rejected" || @permit.status == "draft") && (@permit.approver == current_user || @permit.author == current_user) %>
      <%= link_to 'Edit permit', edit_permit_path(@permit), class: "approve-btn edit-btn" %>
    <% end %>
    <% if @permit.status == "draft" || @permit.status == "rejected" && @permit.author == current_user %>
      <%= link_to 'Delete permit', permit_path(@permit), class: "approve-btn reject-btn", method: :delete, data: { confirm: "Deleting permit... Are you sure?" } %>
    <% end %>
    <% if @permit.who_with == current_user && @permit.author == current_user %>
      <%= link_to 'Delete draft', permit_path(@permit), method: :delete, data: { confirm: "Deleting permit... Are you sure?" } %>
        <%= link_to 'Submit for Approval', permit_request_approval_path(@permit), method: :get %>
    <% end %>
    <div class="detail-card-permit">
      <div class="author-avatar">
        <img class="avatar permit-show" src= <%= @permit.author.avatar %> />
        <div class="author-name">
          <p>Author: <%= @permit.author.fullname %></p>
          <p>Role: <%= @permit.author.role %></p>
        </div>
      </div>
      <hr>
      <% if @permit.approver.present? %>
        <div class="approver-avatar">
          <img class="avatar permit-show" src= <%= @permit.approver.avatar %> />
          <div class="approver-name">
            <p>Approver: <%= @permit.approver.fullname %></p>
            <p>Role: <%= @permit.approver.role %></p>
          </div>
        </div>
      <% else %>
        <div class="approver-avatar">
          <p>Approver to be confirmed</p>
        </div>
      <% end %>
    </div>
  </div>
</div>



<script>
  progressOne = document.getElementById("progress-one");
  progressTwo = document.getElementById("progress-two");
  expired = document.getElementById("expired-banner");
  statusBar = document.querySelector(".status-container");
  icons = document.querySelectorAll("i");

  <% if @permit.status == "pending approval" %>
    progressOne.style.backgroundColor = "#1BAA6F";
    icons.forEach(function(icon) {
      icon.style.display = "none";
    })
    icons[2].style.display = "block";
    icons[4].style.display = "block";
    icons[6].style.display = "block";
  <% elsif @permit.status == "rejected" %>
    icons[3].style.color = "#E67E22";
  <% elsif @permit.status == "approved" %>
    progressOne.style.backgroundColor = "#1BAA6F";
    progressTwo.style.backgroundColor = "#1BAA6F";
    icons.forEach(function(icon) {
      icon.style.display = "none";
    })
    icons[2].style.display = "block";
    icons[5].style.display = "block";
    icons[7].style.display = "block";
  <% elsif @permit.status == "expired" %>
    icons.forEach(function(icon) {
      icon.style.color = "#f90606";
    })
    icons[1].style.display = "none";
    icons[0].style.display = "block";
    progressOne.style.backgroundColor = "#f90606";
    progressTwo.style.backgroundColor = "#f90606";
    expired.style.display = "block";
    statusBar.style.opacity = "0.3";
  <% end %>

  var sectionItems = document.querySelectorAll(".section-item");
  sectionItems.forEach((sectionItem) => {
    sectionItem.addEventListener("click", (event) => {
      var deselectedSectionHeader = document.querySelector(".section-header-active");
      var selectedSectionHeader = event.currentTarget;
      deselectedSectionHeader.classList.remove("section-header-active");
      selectedSectionHeader.classList.add("section-header-active");
      var sectionId = event.currentTarget.dataset.id
      var selectedSections = document.querySelectorAll(`div.selected-section`);
      var selectedSection;
      var deselectedSection;
      selectedSections.forEach((element) => {
        if(element.dataset.id == sectionId) {
          selectedSection = element;
        }
        if(element.className == "selected-section show-section") {
          deselectedSection = element;
        }
      });
      if (selectedSection != deselectedSection) {
        selectedSection.classList.add("show-section");
        deselectedSection.classList.remove("show-section");
      }
    });
  });
</script>



















